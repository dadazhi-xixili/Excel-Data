# GROUPBY

## 语法

**GROUPBY**(分组数组,值数组,函数,[行标题],[总计小计],[排序依据],[筛选数组],[层次结构])  
**GROUPBY**(row_fieldsvalues，function，[field_headers]，[total_depth]，[sort_order]，[filter_array]，[field_relationship])

### 参数

1. 分组数组 row_array：用于分组的行字段数组。
2. 值数组 value_array：需要聚合计算的值数组。

3. 函数 function：应用于每个分组的聚合函数。

4. 行标题 field_headers：指定行标题显示方式。
   - 默认自动判定。
   - 0：否。
   - 1：是，不显示。
   - 2：否，但生成。
   - 3：是并显示。
5. 总计小计 total_depth：总计和小计的显示方式。
   - 默认自动判定。
   - 0：不显示。
   - 1：总计。
   - 2：总计和小计。
   - -1： 顶部总计。
   - -2： 顶部总计和小计。
6. 排序依据 sort_order: 排序依据。
   - 正数: 按数值对应的列正序排序。
   - 负数: 按数值对应的列倒序排序。
   - 数组: 按数组中数值对应的列排序，优先级按值顺序。
7. 筛选数组 filter_array：用于筛选数据的条件数组，与分组数组长度一致，且是单列。
8. 层次结构 field_relationship: 当分组数组为多列时生效，参考透视表的表结构。
   - 0：层次结构
   - 1：表结构

## 概述

函数按分组数组传递值计算，返回分组聚合统计结果。

### 补充

1. 分组数组可以存在多列，行内相同则分为一组。
2. 值数组存在多列时，对应的函数数量应该与列数相同或为一个。
3. 多个聚合项使用 HSTACK、VSTACK 等返回数组存储的函数调用。
4. 使用 LAMBDA 传参时：参数 1 为所在分组数据，参数 2 为所在列数据。

### 常见错误

1. 每个函数返回的结果要是一个值，不能是数组，否则因无法展开报错。

## 示例

### 示例数据 A

|     | A    | B      | C    | D        | E        |
| --- | ---- | ------ | ---- | -------- | -------- |
| 1   | 部门 | 姓名   | 性别 | 销售数量 | 销售金额 |
| 2   | 魏国 | 张辽   | 男   | 79       | 9460     |
| 3   | 蜀国 | 赵云   | 男   | 72       | 8580     |
| 4   | 吴国 | 孙尚香 | 女   | 102      | 12200    |
| 5   | 吴国 | 甘宁   | 男   | 56       | 6760     |
| 6   | 魏国 | 夏侯惇 | 男   | 117      | 13980    |
| 7   | 魏国 | 郭嘉   | 男   | 76       | 9060     |
| 8   | 蜀国 | 刘备   | 男   | 57       | 6840     |
| 9   | 魏国 | 甄姬   | 女   | 114      | 13720    |
| 10  | 蜀国 | 张飞   | 男   | 57       | 6840     |
| 11  | 魏国 | 曹操   | 男   | 111      | 13260    |
| 12  | 蜀国 | 关羽   | 男   | 55       | 6580     |
| 13  | 蜀国 | 诸葛亮 | 男   | 61       | 7280     |
| 14  | 魏国 | 司马懿 | 男   | 91       | 10960    |
| 15  | 吴国 | 孙权   | 男   | 58       | 6900     |

#### 示例 A_1

```excel
GROUPBY(A1:A15,D1:D15,SUM,3)
```

| 组 1 | SUM |
| ---- | --- |
| 魏国 | 79  |
| 魏国 | 117 |
| 魏国 | 76  |
| 魏国 | 114 |
| 魏国 | 111 |
| 魏国 | 91  |
| 合计 | 588 |

| 组 2 | SUM |
| ---- | --- |
| 蜀国 | 72  |
| 蜀国 | 57  |
| 蜀国 | 57  |
| 蜀国 | 55  |
| 蜀国 | 61  |
| 合计 | 302 |

| 组 3 | SUM |
| ---- | --- |
| 吴国 | 102 |
| 吴国 | 56  |
| 吴国 | 58  |
| 合计 | 216 |

组合排序后

| 部门 | 销售数量 |
| ---- | -------- |
| 蜀国 | 302      |
| 魏国 | 588      |
| 吴国 | 216      |
| 总计 | 1106     |

#### 示例 A_2：多列分组依据

```excel
GROUPBY(HSTACK(A1:A15,C1:C15),D1:E15,SUM,3)
```

| 返回 |      |      |          |          |
| ---- | ---- | ---- | -------- | -------- |
|      | 部门 | 性别 | 销售数量 | 销售金额 |
|      | 蜀国 | 男   | 302      | 36120    |
|      | 魏国 | 男   | 474      | 56720    |
|      | 魏国 | 女   | 114      | 13720    |
|      | 吴国 | 男   | 114      | 13660    |
|      | 吴国 | 女   | 102      | 12200    |
|      | 总计 |      | 1106     | 132420   |

#### 示例 A_3：多列函数

```excel
GROUPBY(HSTACK(A2:A15,C2:C15),D2:E15,HSTACK(SUM,MAX),,0)
```

| 返回 |      |     |     |       |
| ---- | ---- | --- | --- | ----- |
|      |      |     | SUM | MAX   |
|      | 蜀国 | 男  | 302 | 8580  |
|      | 魏国 | 男  | 474 | 13980 |
|      | 魏国 | 女  | 114 | 13720 |
|      | 吴国 | 男  | 114 | 6900  |
|      | 吴国 | 女  | 102 | 12200 |

## 致谢

本篇在博主 **超人**(shaowu459) 基础上进行修改。  
示例数据因篇幅和难度问题只选择部分，完整示例数据请访问原文链接。  
原文链接：https://club.excelhome.net/thread-1687101-1-1.html
